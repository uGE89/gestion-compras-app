<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control v4 - Sincronización y Pruebas</title>
    <script type="module" src="./tailwind-loader.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0ea5e9; /* sky-500 */
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-800">Panel de Control (v4)</h1>
            <p class="text-slate-500 mt-2">Herramienta para Sincronización y Pruebas de Cloud Functions.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <h2 class="text-2xl font-bold mb-4">Configuración General</h2>
            <div class="space-y-4">
                 <div>
                    <label for="full-sync-url" class="block text-sm font-medium text-slate-700">URL Sincronización COMPLETA (sincronizarTodo)</label>
                    <input type="text" id="full-sync-url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="https://syncfull-...">
                </div>
                 <div>
                    <label for="quick-sync-url" class="block text-sm font-medium text-slate-700">URL Sincronización RÁPIDA (syncnewcontacts)</label>
                    <input type="text" id="quick-sync-url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="https://syncnewcontacts-...">
                </div>
                <div>
                    <label for="delete-url" class="block text-sm font-medium text-slate-700">URL Función de Eliminación</label>
                    <input type="text" id="delete-url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="https://deletefirestorecollection-...">
                </div>
                 <div>
                    <label for="secret-key" class="block text-sm font-medium text-slate-700">Clave Secreta (del archivo .env)</label>
                    <input type="password" id="secret-key" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-slate-600">Configuración de Pruebas</h3>
                    <div>
                        <label for="test-hardcoded-url" class="block text-sm font-medium text-slate-700">URL Prueba Hardcoded</label>
                        <input type="text" id="test-hardcoded-url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="https://testhardcodedauth-...">
                    </div>
                     <div>
                        <label for="test-env-url" class="block text-sm font-medium text-slate-700">URL Prueba .env</label>
                        <input type="text" id="test-env-url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="https://testenvcredentials-...">
                    </div>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                 <div>
                    <h3 class="text-xl font-bold text-sky-700">Sincronizar Datos</h3>
                    <button id="btn-quick-sync" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                        <span class="material-icons">fast_forward</span> Sinc. Rápida (Nuevos Contactos)
                    </button>
                    <button id="btn-full-sync" class="w-full mt-2 bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 text-sm">
                        <span class="material-icons">sync</span> Sinc. Completa (Lenta)
                    </button>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="text-xl font-bold text-indigo-700">Pruebas y Diagnóstico</h3>
                     <button id="btn-test-env" class="w-full mt-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                        <span class="material-icons">fact_check</span> Probar Credenciales .env
                    </button>
                    <button id="btn-test-hardcoded" class="w-full mt-2 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 text-sm">
                        <span class="material-icons">code</span> Probar Credenciales Hardcoded
                    </button>
                </div>

                 <div class="border-t pt-4">
                    <h3 class="text-xl font-bold text-red-700">Eliminar Datos (¡Peligro!)</h3>
                    <select id="collection-to-delete" class="block w-full rounded-md border-slate-300 shadow-sm p-2 mt-2">
                        <option value="">-- Selecciona una colección --</option>
                        <option value="alegra_contacts">Contactos (alegra_contacts)</option>
                        <option value="alegra_categories">Categorías (alegra_categories)</option>
                    </select>
                    <button id="btn-delete" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                        <span class="material-icons">delete_forever</span> Eliminar Colección Seleccionada
                    </button>
                </div>
            </div>
            
            <div class="bg-slate-900 text-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-100">Consola</h2>
                    <div id="loader" class="spinner hidden"></div>
                </div>
                <pre id="log-output" class="text-sm font-mono whitespace-pre-wrap h-96 overflow-y-auto bg-slate-800 p-4 rounded-md">Esperando acciones...</pre>
            </div>
        </div>
    </div>

    <script>
        // Obtener elementos del DOM de producción
        const fullSyncUrlInput = document.getElementById('full-sync-url');
        const quickSyncUrlInput = document.getElementById('quick-sync-url');
        const deleteUrlInput = document.getElementById('delete-url');
        const secretKeyInput = document.getElementById('secret-key');
        const btnFullSync = document.getElementById('btn-full-sync');
        const btnQuickSync = document.getElementById('btn-quick-sync');
        const btnDelete = document.getElementById('btn-delete');
        const collectionToDeleteSelect = document.getElementById('collection-to-delete');
        
        // ====== OBTENER NUEVOS ELEMENTOS DEL DOM PARA LAS PRUEBAS ======
        const testHardcodedUrlInput = document.getElementById('test-hardcoded-url');
        const testEnvUrlInput = document.getElementById('test-env-url');
        const btnTestHardcoded = document.getElementById('btn-test-hardcoded');
        const btnTestEnv = document.getElementById('btn-test-env');
        
        const logOutput = document.getElementById('log-output');
        const loader = document.getElementById('loader');

        const showLoader = (show) => loader.classList.toggle('hidden', !show);
        const logMessage = (message, type = 'info') => {
            const now = new Date().toLocaleTimeString();
            const colors = { info: 'text-slate-400', success: 'text-green-400', error: 'text-red-400', warning: 'text-yellow-400' };
            logOutput.innerHTML += `<span class="${colors[type] || colors.info}">[${now}] ${message}\n</span>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        };
        
        logOutput.innerHTML = '';
        logMessage('Panel de control v4 inicializado.');

        async function callFunction(baseUrl, params = {}, useSecret = true) {
            // Guardar la configuración en el navegador para la próxima vez
            saveConfigToLocalStorage();

            const secret = secretKeyInput.value.trim();
            if (!baseUrl || (useSecret && !secret)) {
                logMessage('Error: La URL y la Clave Secreta (si es requerida) son obligatorias.', 'error');
                return;
            }
            
            const urlParams = useSecret ? new URLSearchParams({ secret, ...params }) : new URLSearchParams(params);
            const fullUrl = `${baseUrl}?${urlParams.toString()}`;

            logMessage(`Invocando URL: ${useSecret ? fullUrl.replace(secret, '********') : fullUrl}`, 'info');
            showLoader(true);

            try {
                const response = await fetch(fullUrl);
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.error || responseData.message || `Error del servidor: ${response.status}`);
                logMessage(`¡Éxito!`, 'success');
                logOutput.innerHTML += `${JSON.stringify(responseData, null, 2)}\n`;
            } catch (error) {
                logMessage(`Error: ${error.message}`, 'error');
            } finally {
                showLoader(false);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        }

        // --- Funciones para persistir la configuración en el navegador ---
        const configInputIds = ['full-sync-url', 'quick-sync-url', 'delete-url', 'secret-key', 'test-hardcoded-url', 'test-env-url'];

        function saveConfigToLocalStorage() {
            configInputIds.forEach(id => {
                const input = document.getElementById(id);
                // No guardar la clave secreta si está vacía para evitar sobreescribir una guardada
                if (input.type === 'password' && !input.value) return;
                localStorage.setItem(id, input.value);
            });
        }

        function loadConfigFromLocalStorage() {
            logMessage('Cargando configuración guardada...', 'info');
            configInputIds.forEach(id => {
                const savedValue = localStorage.getItem(id);
                if (savedValue) document.getElementById(id).value = savedValue;
            });
        }

        // Event Listeners para funciones de producción
        btnQuickSync.addEventListener('click', () => callFunction(quickSyncUrlInput.value.trim()));
        btnFullSync.addEventListener('click', () => callFunction(fullSyncUrlInput.value.trim()));
        btnDelete.addEventListener('click', () => {
            const collectionToDelete = collectionToDeleteSelect.value;
            if (!collectionToDelete) { alert('Por favor, selecciona una colección.'); return; }
            if (confirm(`¡ADVERTENCIA!\n\n¿Estás seguro de eliminar la colección "${collectionToDelete}"?`)) {
                callFunction(deleteUrlInput.value.trim(), { collection: collectionToDelete, confirm: 'true' });
            }
        });

        // ====== NUEVOS EVENT LISTENERS PARA LOS BOTONES DE PRUEBA ======
        // Las funciones de prueba no requieren la clave secreta
        btnTestEnv.addEventListener('click', () => callFunction(testEnvUrlInput.value.trim(), {}, false));
        btnTestHardcoded.addEventListener('click', () => callFunction(testHardcodedUrlInput.value.trim(), {}, false));

        // Cargar la configuración al iniciar la página
        loadConfigFromLocalStorage();
    </script>
</body>
</html>
